import { FC, useEffect, useState } from 'react'
import {
  Alert,
  Box,
  Button,
  ButtonGroup,
  Paper,
  Popover,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  IconButton
} from '@mui/material'
import { ConstructionItemState } from './construction-interface'
import { Delete } from '@mui/icons-material';

interface ConstructionItemFieldProps {
  data?: ConstructionItemState[]
  onChange: (data: ConstructionItemState[], dataDeleted: ConstructionItemState[]) => void
}

const ExploitItem: FC<ConstructionItemFieldProps> = ({ data, onChange }) => {
  const initialLicenseFees: ConstructionItemState[] = data
    ? data.map((e: ConstructionItemState) => ({
        id: e.id,
        constructionId: e.constructionId,
        name: e.name,
        x: e.x,
        y: e.y,
        amountWaterExploited: e.amountWaterExploited,
        miningMode: e.miningMode,
        waterDepthFrom: e.waterDepthFrom,
        waterDepthTo: e.waterDepthTo,
        staticWL: e.staticWL,
        dynamicWL: e.dynamicWL,
        depthFilterTubeFrom: e.depthFilterTubeFrom,
        depthFilterTubeTo: e.depthFilterTubeTo
      }))
    : []

    const [constructionItems, setConstructionItems] = useState<ConstructionItemState[]>(initialLicenseFees);
    const [itemDelete, setItemDelete] = useState<ConstructionItemState[]>([]);

  const addConstructionItem = () => {
    const newItem: ConstructionItemState = {
      id: 0,
      constructionId: 0,
      name: '',
      x: 0,
      y: 0,
      amountWaterExploited: 0,
      miningMode: 0,
      waterDepthFrom: 0,
      waterDepthTo: 0,
      staticWL: 0,
      dynamicWL: 0,
      depthFilterTubeFrom: 0,
      depthFilterTubeTo: 0
    }
    setConstructionItems(prevItems => [...prevItems, newItem])
  }

  const [deleteConfirmAnchorEl, setDeleteConfirmAnchorEl] = useState<HTMLButtonElement | null>(null);
  const deleteConfirmOpen = Boolean(deleteConfirmAnchorEl);
  const [deleteTargetIndex, setDeleteTargetIndex] = useState<number | null>(null);

  const DeleteRowData = (event: React.MouseEvent<HTMLButtonElement>, index: number) => {
    setDeleteConfirmAnchorEl(event.currentTarget);
    setDeleteTargetIndex(index);
  };

  const handleDeleteCancel = () => {
    setDeleteConfirmAnchorEl(null);
  };

  const handleDeleteConfirm = () => {
    if (deleteTargetIndex !== null) {
      deleteLicFeeItem(deleteTargetIndex); // Pass the index here
      setDeleteTargetIndex(null);
    }

    setDeleteConfirmAnchorEl(null);
  };

  const deleteLicFeeItem = (index: number) => {
    setConstructionItems((prevItems) => {
      const newItems = [...prevItems];
      const removedItem = newItems.splice(index, 1)[0];

      if (removedItem?.id !== undefined && removedItem?.id > 0) {
        setItemDelete(prevDeletedItems => [...prevDeletedItems, removedItem])
      }

      return newItems
    })

    // Call onChange after the state update
    onChange(constructionItems, itemDelete);
    setDeleteConfirmAnchorEl(null);
  };

  const handleChange = (index: number, prop: keyof ConstructionItemState) => (value: any) => {
    const newConstructionItems = [...constructionItems]
    newConstructionItems[index][prop] = value
    setConstructionItems(newConstructionItems)

    // Call onChange after the state update
    onChange(newConstructionItems, itemDelete)
  }

  useEffect(() => {
    onChange(constructionItems, itemDelete)

    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [constructionItems, itemDelete])

  return (
    <fieldset>
      <legend>
        <Typography variant={'subtitle1'} className='legend__title'>
          VỊ TRÍ CÁC HẠNG MỤC CHÍNH CỦA CÔNG TRÌNH KHAI THÁC SỬ DỤNG NƯỚC
        </Typography>
      </legend>
      <TableContainer component={Paper}>
        <Table sx={{ minWidth: 650 }} aria-label='simple table'>
          <TableHead className='tableHeadItem'>
            <TableRow>
              <TableCell size='small' align='center' rowSpan={2}>
                TT
              </TableCell>
              <TableCell size='small' align='center' rowSpan={2}>
                Số hiệu
              </TableCell>
              <TableCell size='small' align='center' colSpan={2}>
                Tọa độ(VN2000)
              </TableCell>
              <TableCell size='small' align='center' colSpan={2}>
                Tọa độ(WGS84)
              </TableCell>
              <TableCell size='small' align='center' rowSpan={2}>
                Q<sub>KT</sub> <br /> (m<sup>3</sup>/<sub>ngày đêm</sub>)
              </TableCell>
              <TableCell size='small' align='center' rowSpan={2}>
                Chế độ KT <br /> (Giờ/ngày đêm)
              </TableCell>
              <TableCell size='small' align='center' colSpan={2}>
                h<sub>đoạn thu nước </sub>
              </TableCell>
              <TableCell size='small' align='center' colSpan={2}>
                h
              </TableCell>
              <TableCell size='small' align='center' colSpan={2}>
                h<sub>đặt ống lọc</sub>
              </TableCell>
              <TableCell size='small' align='center' rowSpan={2} sx={{ maxWidth: 50 }}>
                <Button className='btn-link' onClick={addConstructionItem}>
                  Thêm
                </Button>
              </TableCell>
            </TableRow>
            <TableRow>
              <TableCell size='small' align='center'>
                X
              </TableCell>
              <TableCell size='small' align='center'>
                y
              </TableCell>
              <TableCell size='small' align='center'>
                Lat
              </TableCell>
              <TableCell size='small' align='center'>
                Lng
              </TableCell>
              <TableCell size='small' align='center'>
                Từ(m)
              </TableCell>
              <TableCell size='small' align='center'>
                Đến(m)
              </TableCell>
              <TableCell size='small' align='center'>
                H<sub>tĩnh(m)</sub>
              </TableCell>
              <TableCell size='small' align='center'>
                H<sub>động(m)</sub>
              </TableCell>
              <TableCell size='small' align='center'>
                Từ(m)
              </TableCell>
              <TableCell size='small' align='center'>
                Đến(m)
              </TableCell>
            </TableRow>
          </TableHead>
          <TableBody className='tableBodyItem'>
            {constructionItems.map((item, index) => (
              <TableRow key={index}>
                <TableCell className="text-center  size='small' align-middle font-13">{index + 1}</TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    name='tenhangmuc'
                    fullWidth
                    placeholder='Tên hạng mục'
                    size='small'
                    value={item.name}
                    onChange={event => handleChange(index, 'name')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='x'
                    fullWidth
                    placeholder='Tọa độ X (VN2000)'
                    size='small'
                    value={item.x}
                    onChange={event => handleChange(index, 'x')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='y'
                    fullWidth
                    placeholder='Tọa độ Y (VN2000)'
                    size='small'
                    value={item.y}
                    onChange={event => handleChange(index, 'y')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='amountWaterExploited'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.amountWaterExploited}
                    onChange={event => handleChange(index, 'amountWaterExploited')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='miningMode'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.miningMode}
                    onChange={event => handleChange(index, 'miningMode')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='miningMode'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.miningMode}
                    onChange={event => handleChange(index, 'miningMode')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    sx={{ input: { textAlign: 'center' } }}
                    variant='standard'
                    name='waterDepthTo'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.waterDepthTo}
                    onChange={event => handleChange(index, 'waterDepthTo')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='staticWL'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.staticWL}
                    onChange={event => handleChange(index, 'staticWL')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='dynamicWL'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.dynamicWL}
                    onChange={event => handleChange(index, 'dynamicWL')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='depthFilterTubeFrom'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.depthFilterTubeFrom}
                    onChange={event => handleChange(index, 'depthFilterTubeFrom')(event.target.value)}
                  />
                </TableCell>
                <TableCell>
                  <TextField
                    variant='standard'
                    sx={{ input: { textAlign: 'center' } }}
                    name='depthFilterTubeTo'
                    fullWidth
                    placeholder=''
                    size='small'
                    value={item.depthFilterTubeTo}
                    onChange={event => handleChange(index, 'depthFilterTubeTo')(event.target.value)}
                  />
                </TableCell>

                <TableCell size='small' align='center'>
                  <>
                    <IconButton
                      aria-describedby={`${item.name}-${index}`}
                      onClick={(event) => DeleteRowData(event, index)} // Pass the index here
                      data-row-id={`${item.name}-${index}`}
                    >
                      <Delete className='tableActionBtn deleteBtn' />
                    </IconButton>
                    <Popover
                      id={deleteConfirmOpen ? `${item.name}-${index}` : undefined}
                      open={deleteConfirmOpen}
                      anchorEl={deleteConfirmAnchorEl}
                      onClose={handleDeleteCancel}
                      anchorOrigin={{
                        vertical: 'bottom',
                        horizontal: 'left',
                      }}
                    >
                      <Alert severity="warning">
                        Xóa bản ghi này ?
                        <Box sx={{ justifyContent: 'center', paddingTop: 4, width: '100%' }}>
                          <ButtonGroup variant="outlined" aria-label="outlined button group">
                            <Button size="small" onClick={() => handleDeleteConfirm()} >
                              Đúng
                            </Button>
                            <Button color='error' size="small" onClick={() => handleDeleteCancel()} >
                              Không
                            </Button>
                          </ButtonGroup>
                        </Box>
                      </Alert>
                    </Popover>
                  </>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </fieldset>
  )
}

export default ExploitItem
